name: Deploy Vue3 + Vite Project of Stellerus
on: 
  push:
    branches:
      - main
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2.3.1
 
      - name: Install dependencies and build
        run: |
          npm install
          npm run build
 
      - name: Deploy
        uses: miaofeng/github-page-actions@v3
        with:
          github_token: ${{ secrets.ACCESS_TOKEN }}   # 替换为你刚刚添加的secret的名字
          publish_dir: ./docs  # 根据你的打包输出目录进行调整
 
      - name: Checkout branch
        uses: actions/checkout@v2
        with:
          ref: main
          path: main
 
      - name: Modify index.html and add 404.html
        run: |
          cd gh-pages
          sed -i '/<\/head>/i <script>(function(l){if(l.search[1]==="/"){var decoded=l.search.slice(1).split("&").map(function(s){return s.replace(/~and~/g,"&")}).join("?");window.history.replaceState(null,null,l.pathname.slice(0,-1)+decoded+l.hash)}}(window.location))</script>' index.html
  
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Stellerus-Tech</title><script type="text/javascript">var pathSegmentsToKeep=0;var l=window.location;l.replace(l.protocol+\"//\"+l.hostname+(l.port?\":\"+l.port:\"\")+l.pathname.split(\"/\").slice(0,1+pathSegmentsToKeep).join(\"/\")+\"/?/\"+l.pathname.slice(1).split(\"/\").slice(pathSegmentsToKeep).join(\"/\").replace(/&/g,\"~and~\")+(l.search?\"&\"+l.search.slice(1).replace(/&/g,\"~and~\"):\"\")+l.hash);</script></head><body></body></html>' > 404.html

      #绑定自有域名
      # - name: Add CNAME file
      #   run: |
      #     cd gh-pages
      #     # 添加域名绑定文件CNAME，请替换为你的自定义域名。如果没有自定义域名那么就将Add CNAME操作整个删掉
      #     echo 'your.domain' > CNAME
 
 
      - name: Commit and push changes
        run: | 
          cd gh-pages
          # 改为自己的邮箱和名称
          git config --global user.email "miao.feng@outlook.de"
          git config --global user.name "MiaoFeng"
          # 同样，如果没有添加CNAME的话就将下面的CNAME删掉
          # git add index.html 404.html CNAME
          git add index.html 404.html
          git commit -m "Update index.html and add 404.html"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
 
 
          
 
